var Y=Object.defineProperty;var F=n=>{throw TypeError(n)};var Z=(n,e,t)=>e in n?Y(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var d=(n,e,t)=>Z(n,typeof e!="symbol"?e+"":e,t),ee=(n,e,t)=>e.has(n)||F("Cannot "+t);var l=(n,e,t)=>(ee(n,e,"read from private field"),t?t.call(n):e.get(n)),g=(n,e,t)=>e.has(n)?F("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t);import{b2 as te,aK as v,ao as y,E as p,a3 as f,a6 as Q}from"./8OrGzRw7.js";const se=te,N="__PANELS__";function ie(){return window[N]}function ne(){const n=window;return n[N]||(n[N]={}),n[N]}function V(n,e){const t=ne();t[n]=e}function A(n){var e;return(e=ie())==null?void 0:e[n]}function pe(n,e){var t=A("overlays");return t==null&&(t=[]),t.push({id:n,close:e}),V("overlays",t),t.length-1}function j(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){const e=Math.random()*16|0;return(n=="x"?e:e&3|8).toString(16)})}function fe(n){var i,s;let e=A("overlays");if(!e||e.length==0)return;if(e.length==1){(i=e[0])==null||i.close(),e=[],V("overlays",e);return}const t=e.findIndex(a=>a.id===n);if(t!==-1){for(let a=t;a<e.length;a++)(s=e[a])==null||s.close();e=e.slice(0,t),V("overlays",e)}}function me(n){let e=A("overlays");if(!e||e.length===0)return;const t=e[e.length-1];t!=null&&t.id===n&&(t.close(),e.pop(),V("overlays",e))}class H{constructor(){d(this,"data",[]);d(this,"callbacks",[])}onUpdate(e){this.callbacks.push(e)}sendUpdate(){for(const e of this.callbacks)e(this.data)}add(e){this.data.push({id:j(),timestamp:Date.now(),text:e,executedAction:!1,actions:[]}),this.sendUpdate()}addAction(e,t){const i=j();this.data.push({id:i,timestamp:Date.now(),text:e,executedAction:!1,actions:t.map(s=>({text:s.text,task:()=>{s.task();for(const a of this.data)a.id==i&&(a.executedAction=!0,this.sendUpdate())}}))}),this.sendUpdate()}}class q{constructor(e,t){d(this,"id");d(this,"socket");this.id=e,this.socket=t}addMessageHandler(e,t){this.socket.addMessageHandler(this.id,e,t)}sendMessage(e,t){this.socket.sendMessage({pluginID:this.id,messageID:e,data:t})}removeMessageHandler(e,t){this.socket.removeMessageHandler(this.id,e)}}async function K(n){const e=new Blob([n],{type:"text/javascript"}),t=URL.createObjectURL(e),i=await import(t);return URL.revokeObjectURL(t),i}class B{constructor(){d(this,"socket",null);d(this,"messageHandlers",{});d(this,"pluginManagers",{});d(this,"pluginSelectors",{});d(this,"log",[]);d(this,"maxLogSize",100);d(this,"maxQueueSize",256);d(this,"outgoingQueue",[]);d(this,"isDraining",!1)}async initPlugins(e,t,i){const s={};await Promise.all(e.map(async a=>{try{const o=await K(t[a.details.id]),r=o==null?void 0:o.default;this.pluginSelectors[a.details.id]=r;const m=r("Manager"),c=new m(new q(a.details.id,this),a.details,a.config,i);s[a.details.id]=c,typeof c.onInit=="function"&&await c.onInit()}catch(o){console.error(`[plugin:${a.details.id}] Failed to initialize`,o)}})),this.pluginManagers={...this.pluginManagers,...s}}async initSocket(e){this.log=[];const t=window.location.hostname,s=`${window.location.protocol==="https:"?"wss":"ws"}://${t}:8002`,a=new WebSocket(s);this.socket=a,await new Promise((o,r)=>{const m=()=>{console.log("WebSocket connection opened:",s),h(),o()},c=u=>{console.error("WebSocket error:",u),h(),e(),r(u)},h=()=>{a.removeEventListener("open",m),a.removeEventListener("error",c)};a.addEventListener("open",m),a.addEventListener("error",c)}),a.addEventListener("open",()=>{this.drainQueue()}),this.drainQueue(),a.addEventListener("message",o=>{this.log=[...this.log,o.data].slice(-this.maxLogSize);try{const r=JSON.parse(o.data);console.log(r.pluginID,r.messageID,r.data),this.handleMessage(r.pluginID,r.messageID,r.data)}catch(r){console.error("Failed to parse message:",r,o.data)}}),a.addEventListener("error",o=>{console.error("WebSocket error:",o),e()}),a.addEventListener("close",()=>{console.log("WebSocket connection closed"),e()})}close(){var e;(e=this.socket)==null||e.close()}handleMessage(e,t,i){const s=this.messageHandlers[`${e}-${t}`];s?s(i):console.warn(`No handler for message kind: ${e}-${t}`)}addMessageHandler(e,t,i){this.messageHandlers[`${e}-${t}`]=i}sendMessage(e){const t=JSON.stringify(e);this.outgoingQueue.length>=this.maxQueueSize&&(console.warn("Outgoing queue full. Dropping oldest message."),this.outgoingQueue.shift()),this.outgoingQueue.push(t),this.drainQueue()}clearQueue(){this.outgoingQueue.length=0}drainQueue(){if(!this.isDraining&&!(!this.socket||this.socket.readyState!==WebSocket.OPEN)){this.isDraining=!0;try{for(;this.socket&&this.socket.readyState===WebSocket.OPEN&&this.outgoingQueue.length>0;){const e=this.outgoingQueue.shift();try{this.socket.send(e)}catch(t){this.outgoingQueue.unshift(e),console.error("Send failed; will retry later.",t);break}}}finally{this.isDraining=!1}}}removeMessageHandler(e,t){delete this.messageHandlers[`${e}-${t}`]}}const ae={id:"com.bylazar.pluginsjscore",name:"Plugins JS Core",letterName:"PJC",description:"Plugins Javascript Core",websiteURL:"https://panels.bylazar.com",mavenURL:"",packageString:"",version:"1.1.43",pluginsCoreVersion:"1.1.43",author:"Lazar",manager:"",components:[],templates:[],includedPluginsIDs:[],changelog:[{version:"1.1.43",release_date:"28.08.2025",changes:[{type:"fixed",description:"Installed chokidar.",upgrading:""}]},{version:"1.1.42",release_date:"28.08.2025",changes:[{type:"fixed",description:"Fixed some imports.",upgrading:""}]},{version:"1.1.41",release_date:"27.08.2025",changes:[{type:"fixed",description:"Fixed Overlay component.",upgrading:""}]},{version:"1.1.40",release_date:"27.08.2025",changes:[{type:"fixed",description:"Fixed import for Link in docs.",upgrading:""}]},{version:"1.1.39",release_date:"27.08.2025",changes:[{type:"deprecated",description:"Moved common docs components for Panels and Docs Website to ftc-panels-docs",upgrading:"Use the new library"},{type:"fixed",description:"Properly exported typed svelte components.",upgrading:""}]},{version:"1.1.38",release_date:"26.08.2025",changes:[{type:"added",description:"Added generic functions to fetch latest versions from GitHub hosted mavens",upgrading:""}]},{version:"1.1.37",release_date:"25.08.2025",changes:[{type:"fixed",description:"Fixed docs handling of URL special characters for selected link",upgrading:""},{type:"fixed",description:"Fixed JS Core plugin config versions",upgrading:""}]},{version:"1.1.36",release_date:"25.08.2025",changes:[{type:"fixed",description:"Fixed minor docs shared UI logic",upgrading:""}]}]},U={isEnabled:!0,isDev:!1};async function oe(n){return await re("lazarcloud","ftcontrol-maven","releases",n)}async function re(n,e,t,i){var s;try{const a=await fetch(`https://raw.githubusercontent.com/${n}/${e}/refs/heads/main/${t}/${i.replaceAll(".","/")}/maven-metadata.xml`);if(!a.ok)throw new Error(`HTTP ${a.status}`);const o=await a.text();return((s=new DOMParser().parseFromString(o,"application/xml").querySelector("latest"))==null?void 0:s.textContent)||""}catch{return""}}const le="PanelsDB",k="PluginData",ce=1;async function X(){return new Promise((n,e)=>{const t=indexedDB.open(le,ce);t.onupgradeneeded=()=>{const i=t.result;i.objectStoreNames.contains(k)||i.createObjectStore(k)},t.onsuccess=()=>n(t.result),t.onerror=()=>e(t.error)})}async function G(n,e){const t=await X();return new Promise((i,s)=>{const r=t.transaction(k,"readwrite").objectStore(k).put(e,n);r.onsuccess=()=>i(!0),r.onerror=()=>s(r.error)})}async function J(n){const e=await X();return new Promise((t,i)=>{const o=e.transaction(k,"readonly").objectStore(k).get(n);o.onsuccess=()=>t(o.result??null),o.onerror=()=>i(o.error)})}const O={id:"com.bylazar.panels",name:"Panels",letterName:"P",description:"Empty Panels Installation ready to be extended",websiteURL:"https://panels.bylazar.com",mavenURL:"https://mymaven.bylazar.com/releases",packageString:"com.bylazar:panels:<VERSION>",version:"1.0.3",pluginsCoreVersion:"1.1.43",author:"Lazar",manager:"",components:[],templates:[],includedPluginsIDs:[],changelog:[{version:"1.0.3",release_date:"9.09.2025",changes:[{type:"other",description:"Updated SDK to 11.0.0",upgrading:""}]},{version:"1.0.2",release_date:"27.08.2025",changes:[{type:"docs",description:"Added a Core Plugins Section & Fixed UI on Safari",upgrading:""}]},{version:"1.0.1",release_date:"27.08.2025",changes:[{type:"fixed",description:"Made Panels widgets mobile responsive",upgrading:""},{type:"other",description:"Updated ftc-panels to 1.1.43",upgrading:""}]},{version:"1.0.0",release_date:"26.08.2025",changes:[{type:"other",description:"First release",upgrading:""}]}]};class de{constructor(){d(this,"config",O);d(this,"settings",U)}onInit(){}static async getNewVersion(){return await oe(O.id)}}var S,P,b,D,I,M,$,T,L,E,_,C,R;class he{constructor(){g(this,S,v(y([])));g(this,P,v(y([])));d(this,"notificationsManager",new H);g(this,b,Q(()=>{let e=[];for(const t of this.plugins)for(const i of t.details.templates){const s=new Set([]),a=new Set(this.plugins.map(r=>r.details.id));for(const r of i.widgets)for(const m of r.widgets)s.add(m.pluginID);for(const r of i.navlets)s.add(r.pluginID);const o=Array.from(s).filter(r=>!a.has(r));e.push({...i,pluginID:t.details.id,missingPlugins:o})}return e}));g(this,D,v(y([])));d(this,"socket",new B);g(this,I,v(!1));d(this,"updateInterval",null);d(this,"interval",null);g(this,M,v(y({})));g(this,$,v(y({})));g(this,T,v(y({})));g(this,L,v(y({})));g(this,E,Q(()=>{if(!this.isConnected)return!1;for(const e of this.plugins)for(const t of e.details.templates)if(!this.pluginsTemplatesPreviews[`${e.details.id}/${t.name}`])return!1;return!0}));g(this,_,v(y([])));g(this,C,v(!1));g(this,R,v(!1))}get plugins(){return p(l(this,S))}set plugins(e){f(l(this,S),e,!0)}get notifications(){return p(l(this,P))}set notifications(e){f(l(this,P),e,!0)}get allTemplates(){return p(l(this,b))}set allTemplates(e){f(l(this,b),e)}get skippedPlugins(){return p(l(this,D))}set skippedPlugins(e){f(l(this,D),e,!0)}get isConnected(){return p(l(this,I))}set isConnected(e){f(l(this,I),e,!0)}get reloadIndexes(){return p(l(this,M))}set reloadIndexes(e){f(l(this,M),e,!0)}get lastVersionNotificationTime(){return p(l(this,$))}set lastVersionNotificationTime(e){f(l(this,$),e,!0)}get changedTimestamps(){return p(l(this,T))}set changedTimestamps(e){f(l(this,T),e,!0)}get pluginsTemplatesPreviews(){return p(l(this,L))}set pluginsTemplatesPreviews(e){f(l(this,L),e,!0)}get isPrepared(){return p(l(this,E))}set isPrepared(e){f(l(this,E),e)}get devPlugins(){return p(l(this,_))}set devPlugins(e){f(l(this,_),e,!0)}get hasDevServer(){return p(l(this,C))}set hasDevServer(e){f(l(this,C),e,!0)}createDevServerInterval(){this.interval!==null&&clearInterval(this.interval),this.interval=setInterval(async()=>{await this.updateDevPlugins(!0)},this.hasDevServer?500:1e4)}async updateDevPlugins(e=!1){var i;let t;try{t=await(await this.fetchWithRetry("http://localhost:3001/plugins",{},1)).json(),this.hasDevServer||this.createDevServerInterval(),this.hasDevServer=!0}catch(s){console.error("Failed to fetch live plugins:",s),this.hasDevServer&&this.createDevServerInterval(),this.hasDevServer=!1;return}for(const s of t)if(this.devPlugins.includes(s.id)||this.devPlugins.push(s.id),s.lastChanged!=this.changedTimestamps[s.id]){console.log("Rebuilding",s.name);let o=await(await this.fetchWithRetry(`http://localhost:3001/plugins/${s.id}`,{},1)).json(),m=await(await this.fetchWithRetry(`http://localhost:3001/plugins/${s.id}/svelte.js`,{},1)).text();const{default:c}=await K(m||"");this.socket.pluginSelectors[o.id]=c;let h=structuredClone(U);for(const u of this.plugins)u.details.id==s.id&&(h=u.config);if(e){const u=c("Manager"),x=this.socket.pluginManagers[o.id].state.data;this.socket.pluginManagers[o.id]=new u(new q(o.id,this.socket),o,h,this.notificationsManager),this.socket.pluginManagers[o.id].state.data=x;for(const w of Object.values(this.socket.pluginManagers[o.id].state.data))for(const W of w.callbacks)W(w.value);(i=this.socket.pluginManagers[o.id])==null||i.onInit()}for(const u of o.templates){const x=`${s.id}/${u.name}`;delete this.pluginsTemplatesPreviews[x]}for(const u of this.plugins)u.details.id==s.id&&(u.details=o);this.reloadIndexes[o.id]++,console.log("Reloaded plugin",s.id),this.changedTimestamps[s.id]=s.lastChanged,this.socket.sendMessage({pluginID:"core",messageID:"pluginReloaded",data:o.id})}}async hasInternetConnection(){try{return(await fetch("https://raw.githubusercontent.com/lazarcloud/ftcontrol-maven/refs/heads/main/dev/com/bylazar/panels/maven-metadata.xml",{cache:"no-cache"})).ok}catch{return!1}}get wasSocketOpened(){return p(l(this,R))}set wasSocketOpened(e){f(l(this,R),e,!0)}async init(e=!0){try{e&&(this.plugins=[],this.hasDevServer=!1,this.updateInterval!==null&&clearInterval(this.updateInterval),this.interval!==null&&clearInterval(this.interval),this.notificationsManager=new H,this.skippedPlugins=[],this.socket=new B),this.notificationsManager.callbacks=[],this.notificationsManager.onUpdate(c=>{this.notifications=c}),this.notifications=this.notificationsManager.data,this.isConnected=!1;const t=Date.now();console.log("[init] Starting initialization...");const i=await this.getPlugins();this.plugins=i.data.plugins,this.wasSocketOpened&&location.reload(),this.plugins.forEach(c=>{this.reloadIndexes[c.details.id]=0,this.changedTimestamps[c.details.id]=-1,this.lastVersionNotificationTime[c.details.id]=-1}),console.log(`[init] Loaded ${this.plugins.length} plugins`),this.plugins.forEach(c=>{this.reloadIndexes[c.details.id]++,this.changedTimestamps[c.details.id]=0,this.lastVersionNotificationTime[c.details.id]=0}),this.skippedPlugins=i.data.skippedPlugins,console.log(`[init] Skipped ${this.skippedPlugins.length} plugins`);const s=Date.now();this.interval!==null&&clearInterval(this.interval);const a=se?"http://localhost:8001/":"/",o={},m=await(await fetch(`${a}api/shas`)).json();await Promise.all(this.plugins.map(async c=>{const h=c.details.id;let u=m[h]??"",x=!0;if(u!=="")try{const w=await J(`${h}_sha`);u===w&&(o[h]=await J(`${h}_data`)??"",x=!1)}catch{}if(x)try{const z=(await(await fetch(`${a}api/svelte/${h}`)).text()||"").trim();if(!z){console.warn(`[plugin:${h}] Missing manager source`);return}await Promise.all([G(`${h}_data`,z),G(`${h}_sha`,u)]),o[h]=z}catch(w){console.warn(`[plugin:${h}] Failed to refresh`,w)}})),await this.socket.initPlugins(this.plugins,o,this.notificationsManager);try{await this.updateDevPlugins(!0)}catch{}this.plugins.push({details:O,config:U}),this.plugins.push({details:ae,config:U}),this.socket.pluginManagers["com.bylazar.panels"]=new de,setTimeout(()=>{this.createDevServerInterval(),console.log("[init] Dev plugin interval set up")},100),await this.socket.initSocket(async()=>{this.notificationsManager.add("Lost connection to robot"),await this.init(!1)}),console.log(`[init] socket.init() took ${Date.now()-s}ms`),this.isConnected=!0,this.wasSocketOpened=!0,this.updateInterval!==null&&clearInterval(this.updateInterval),this.updateInterval=setInterval(async()=>{await this.hasInternetConnection()&&(console.log("Has internet"),await this.checkVersions())},1e4),console.log(`[init] Initialization complete in ${Date.now()-t}ms`),this.plugins.map(c=>c.details.id).includes("com.bylazar.exampleplugin")&&this.notificationsManager.addAction("Don't use default plugin id",[{text:"OK",task:()=>{}},{text:"Details",task:()=>{}}])}catch(t){console.error("[init] Error during initialization:",t),await this.waitTwoSeconds(),await this.init(e)}}waitTwoSeconds(){return new Promise(e=>{setTimeout(()=>{e("Done waiting 2 seconds!")},2e3)})}close(){this.isConnected=!1,this.interval&&clearInterval(this.interval),this.socket.close()}fetchWithTimeout(e,t={},i=5e3){const s=new AbortController,a=setTimeout(()=>s.abort(),i);return fetch(e,{...t,signal:s.signal}).finally(()=>clearTimeout(a))}fetchWithRetry(e,t={},i=3,s=1e3,a=250){return this.fetchWithTimeout(e,t,s).catch(o=>{if(i>0)return console.warn(`Retrying... (${i} left), Error: ${o.message}`),new Promise(r=>setTimeout(r,a)).then(()=>this.fetchWithRetry(e,t,i-1,s,a*2));throw o})}async getSha(e=0){if(e>5)throw Error("Tried too many times.");const t=window.location.origin;try{const s=await(await this.fetchWithRetry(`${t}/api/sha256`,{})).text();return s&&s.trim()!="null"?s:this.getSha(e+1)}catch(i){throw console.warn("Fetch failed, retrying...",i),i}}async getPlugins(){const e=window.location.origin;return await(await this.fetchWithRetry(`${e}/api/plugins`,{},5,4e3,500)).json()}async checkVersions(){const e=new Set;for(const t of this.plugins){const i=t.details.includedPluginsIDs;for(const s of i)e.add(s)}for(const t of this.plugins)try{const i=t.details.id,s=this.lastVersionNotificationTime[i]??0;if(Date.now()-s<900*1e3||e.has(i))continue;const a=this.socket.pluginManagers[i];console.log("Checking plugin version",i,a.config.version);const o=await a.constructor.getNewVersion();let r=o!=a.config.version;o==""&&(r=!1),o!=""&&(this.lastVersionNotificationTime[i]=Date.now()),r?this.notificationsManager.addAction(`Plugin ${i} has a new version: ${o}`,[{text:"Website",task:()=>{window.open(t.details.websiteURL,"_blank")}},{text:"Skip",task:()=>{}}]):console.log(`Plugin ${i} is latest`)}catch(i){console.error(i)}}}S=new WeakMap,P=new WeakMap,b=new WeakMap,D=new WeakMap,I=new WeakMap,M=new WeakMap,$=new WeakMap,T=new WeakMap,L=new WeakMap,E=new WeakMap,_=new WeakMap,C=new WeakMap,R=new WeakMap;const ve=new he;export{j as a,pe as b,fe as c,me as d,ve as g};
